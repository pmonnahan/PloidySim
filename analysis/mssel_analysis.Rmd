---
title: "Mssel_analysis"
author: "Patrick Monnahan"
date: "12/27/2018"
output: html_document
toc: true
toc_depth: 3
toc_float: true
---

## Load packages and import/generate data
```{r setup, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(assertthat)
library(ggplot2)
library(dplyr)
library(tidyr)
library(PopGenome)
library(stringr)
library(data.table)
library(magrittr)
library(wrapr)
library(foreach)
library(purrr)
library(IDPmisc)
library(MESS)
library(wesanderson)

ms = read.table("/Users/pmonnahan/Documents/Research/PloidySim/data/mssel_out_2-24-19_fin.txt", head = T)

#Group windows into larger sets
ms %<>% mutate(driftGen = 0)

ms2 = read.table("/Users/pmonnahan/Documents/Research/PloidySim/data/mssel_out_highRe_drift_4-30-19.txt", head = T)

ms3 = read.table("/Users/pmonnahan/Documents/Research/PloidySim/data/mssel_out_5-10-19.txt", head = T)
ms3 %<>% filter(sim_ploidy!=1)

ms = rbind(ms,ms2)

ms %<>% mutate(ints = as.numeric(as.character(cut(bp.start, breaks = 50, labels = seq(1,50)))))
ms3 %<>% mutate(ints = as.numeric(as.character(cut(bp.start, breaks = 50, labels = seq(1,50)))))

ms = rbind(ms, ms3)

ms4 = read.table("/Users/pmonnahan/Documents/Research/PloidySim/data/mssel_d3_moreReps.txt", head = T)
ms4 %<>% filter((s==0.1 | s==0.01))
ms4 %<>% mutate(rep = rep + 20)
ms4 %<>% mutate(ints = as.numeric(as.character(cut(bp.start, breaks = 50, labels = seq(1,50)))))

#THIS IS FUCKING THINGS UP!!
ms = rbind(ms, ms4)

ms4 = read.table("/Users/pmonnahan/Documents/Research/PloidySim/data/mssel_d2_moreReps.txt", head = T)
ms4 %<>% mutate(rep = rep + 40)
ms4 %<>% mutate(ints = as.numeric(as.character(cut(bp.start, breaks = 50, labels = seq(1,50)))))
ms = rbind(ms, ms4)

#Same number of sampled haplotypes.  Is reduced variance in higher ploidies due to higher haplotype sample size.
ds = read.table("~/Documents/Research/PloidySim/data/mssel_out_DS_7-31-19.txt", head = T)
nds = read.table("~/Documents/Research/PloidySim/data/mssel_out_nDS_7-31-19.txt", head = T)
nds.ehh = read.csv("~/Documents/Research/PloidySim/rehh/dom/rehh_csv")

ds %<>% select(-start_freq) %>% mutate(DS="yes")
nds %<>% select(-start_freq) %>% mutate(DS="no")
ms5 = rbind(ds, nds)

ds.files = c("~/Documents/Research/PloidySim/rehh/rehh_tp2_do0.5_1krep_DS.csv", "~/Documents/Research/PloidySim/rehh/rehh_tp4_do0.5_1krep_DS.csv", "~/Documents/Research/PloidySim/rehh/rehh_tp8_do0.5_1krep_DS.csv")
nds.files = c("~/Documents/Research/PloidySim/rehh/rehh_tp2_do0.5_1krep_nDS.csv", "~/Documents/Research/PloidySim/rehh/rehh_tp4_do0.5_1krep_nDS.csv", "~/Documents/Research/PloidySim/rehh/rehh_tp8_do0.5_1krep_nDS.csv")

wrapEHH = function(files){
  all.sum = data.frame()
  for(i in 1:length(files)){
    print(files[i])
    dat = read.csv(files[i])
    dat.sum = dat %>% mutate(traj_ploidy = as.numeric(str_replace(traj_ploidy, "tp","")), sim_ploidy = as.numeric(str_replace(sim_ploidy, "sp","")), dom = as.numeric(str_replace(dom, "do","")), s = as.numeric(str_replace(s, "se","")), N = as.numeric(str_replace(N, "NN","")), mu = as.numeric(str_replace(mu, "mu","")), recomb = as.numeric(str_replace(recomb, "re","")), sampGen = as.numeric(str_replace(sampGen, "sG","")), fuseGen = as.numeric(str_replace(fuseGen, "fG","")), rep = as.numeric(str_replace(rep, "rep", ""))) %>% filter(!is.na(xpehh.p)) %>% mutate(mid = POSITION) %>% nest(-c(sim_ploidy, rep)) %>% mutate(size.xp = map(data, ~getDims(., y.metric = "XPEHH")), size.xp.p = map(data, ~getDims(., y.metric = "xpehh.p")), med.xp = map(data, ~getStat(., "XPEHH")), med.xpp = map(data, ~log(getStat(., "xpehh.p"))), size.ihs = map(data, ~getDims(., y.metric = "iHS")), size.ihs.p = map(data, ~getDims(., y.metric = "ihs.p")), med.ihs = map(data, ~getStat(., "iHS")), med.ihs.p = map(data, ~log(getStat(., "ihs.p")))) %>% select(-data) %>% unnest()
    all.sum = rbind(all.sum, dat.sum)
    remove(dat)
  }
  return(all.sum)
}

ds.ehh = wrapEHH(ds.files)
nds.ehh = wrapEHH(nds.files)
ds.ehh %<>% mutate(DS="yes")
nds.ehh %<>% mutate(DS="no")

CV <- function(data){
  data = data[is.finite(data)]
  return((sd(data, na.rm=T)/(mean(data, na.rm=T)))*100)
  }

lCV <- function(data, N = 10000, n = 100){
    aa = foreach(i = 1:N, .combine = rbind) %do% {
      ndat = sample(data, n)
      sd(ndat, na.rm=T)/(mean(ndat, na.rm=T))*100}
    return(quantile(aa,0.05, na.rm=T))
}

uCV <- function(data, N = 10000, n = 100){
    aa = foreach(i = 1:N, .combine = rbind) %do% {
      ndat = sample(data, n)
      sd(ndat, na.rm=T)/(mean(ndat, na.rm=T))*100}
    return(quantile(aa,0.95, na.rm=T))
}

ds = ms5 %>% group_by(sim_ploidy, DS, rep) %>% mutate(Div = mean(Pi.2) - Pi.1, Tajima.D_1 = abs(Tajima.D_1), Fst = scale(fst)) %>% ungroup() %>% nest(-c(sim_ploidy, DS, rep)) %>% mutate(size.div = map(data, ~getDims(., y.metric = "Div")), size.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")), size.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")), size.e = map(data, ~getDims(., y.metric = "Zeng.E_1")), size.fst = map(data, ~getDims(., y.metric = "Fst")), size.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")), med.d = map(data, ~getStat(., "Tajima.D_1")), med.e = map(data, ~getStat(., "Zeng.E_1")), med.h = map(data, ~getStat(., "Fay.Wu.H_1")), med.fst = map(data, ~getStat(., "Fst")), med.dxy = map(data, ~getStat(., "dxy.1.2"))) %>% select(-data) %>% unnest()

ds %>% group_by(sim_ploidy, DS) %>% select(-rep) %>% summarize_all(sd) %>% gather(variable, value, -c(sim_ploidy, DS)) %>% ggplot(aes(x = as.factor(sim_ploidy), fill = as.factor(DS), y = value)) + geom_bar(stat = "identity", position = "dodge") + facet_wrap(~variable, scales = "free_y")


ehh = rbind(nds.ehh, ds.ehh)

ms6 = merge(ds, ehh, by = c("sim_ploidy", "DS", "rep"), all = T)

ms6 %>% group_by(sim_ploidy, DS) %>% select(-rep) %>% summarize_all(CV) %>% gather(variable, value, -c(sim_ploidy, DS)) %>% ggplot(aes(x = as.factor(sim_ploidy), fill = as.factor(DS), y = value)) + geom_bar(stat = "identity", position = "dodge") + facet_wrap(~variable, scales = "free_y")

ms6 %>% group_by(sim_ploidy, DS) %>% select(-rep) %>% summarize_all(CV) %>% gather(variable, value, -c(sim_ploidy, DS)) %>% ggplot(aes(x = as.factor(sim_ploidy), fill = as.factor(DS), y = value)) + geom_bar(stat = "identity", position = "dodge") + facet_wrap(~variable, scales = "free_y")

ms6.1 = ms6 %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e, "Fst" = med.fst, "Dxy" = med.dxy, "XPEHH" = med.xp, "Rsb" = med.rsb) %>% select(sim_ploidy, DS, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% melt(., id.var = c("sim_ploidy", "DS")) %>% mutate(stat = "MaxValue")

ms6.2 = ms6 %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, "Rsb" = size.rsb) %>% select(sim_ploidy, DS, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% melt(., id.var = c("sim_ploidy", "DS")) %>% mutate(stat = "AUC")

ms6.3 = rbind(ms6.1, ms6.2)

scaleFUN <- function(x) sprintf("%.1f", x)

#Not interesting
# ms6.3 %>% filter(stat == "AUC") %>% group_by(sim_ploidy, DS, variable) %>% summarize(CV = CV(value)) %>% ggplot(., aes(y = CV, fill = as.factor(DS), x = as.factor(sim_ploidy))) + geom_bar(stat="identity", position = position_dodge()) + scale_fill_discrete(name = "Sampling", labels=c("Equal Individuals", "Equal Alleles")) + scale_y_continuous(labels=scaleFUN) + ylab("Var[AUC]") + xlab("Ploidy") + facet_wrap(~variable, scales = "free", shrink = T, nrow = 1) + theme_bw() + theme(axis.text.y=element_blank(), axis.title.y=element_text(size=16), axis.text.x=element_blank(), axis.title.x=element_blank(), legend.text = element_text(size=13), legend.title = element_text(size=14), strip.text = element_text(size=14))

MS6.1 = ms6 %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e, "Fst" = med.fst, "Dxy" = med.dxy, "XPEHH" = med.xp, "iHS" = med.ihs) %>% select(sim_ploidy, DS, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% group_by(sim_ploidy, DS) %>% summarize_all(c("CV", "lCV", "uCV"))

MS6.1 %>% melt(., id.var = c("sim_ploidy", "DS")) %>% separate(variable, c("variable","XX"), "_") %>% spread(XX, value) %>% ggplot(., aes(y = CV, fill = as.factor(DS), x = as.factor(sim_ploidy))) + geom_bar(stat="identity", position = position_dodge()) + geom_errorbar(aes(ymin = lCV, ymax = uCV, width = 0.5), position = position_dodge(width = 0.9)) + scale_fill_discrete(name = "Sampling", labels=c("Equal Individuals", "Equal Alleles")) + scale_y_continuous(labels=scaleFUN) + ylab("Var[MaxValue]") + xlab("Ploidy") + facet_wrap(~variable, scales = "free", shrink = T, nrow = 1) + theme_bw() + theme(axis.text.y=element_blank(), axis.title.y=element_text(size=16), axis.text.x=element_text(size=14), axis.title.x=element_text(size=16), legend.text = element_text(size=13), legend.title = element_text(size=14), strip.text = element_text(size=14))

MS6.1 %>% melt(., id.var = c("sim_ploidy", "DS")) %>% separate(variable, c("variable","XX"), "_") %>% spread(XX, value) %>% filter(variable %in% c("TajD", "Fst", "iHS", "XPEHH")) %>% mutate(Variable = factor(variable, levels=c("TajD", "Fst", "iHS", "XPEHH"))) %>% ggplot(., aes(y = CV, fill = as.factor(DS), x = as.factor(sim_ploidy))) + geom_bar(stat="identity", position = position_dodge()) + geom_errorbar(aes(ymin = lCV, ymax = uCV, width = 0.5), position = position_dodge(width = 0.9)) + scale_fill_discrete(name = "Sampling", labels=c("Equal Individuals", "Equal Alleles")) + scale_y_continuous(labels=scaleFUN) + ylab("CV[MaxValue]") + xlab("Ploidy") + facet_wrap(~Variable, scales = "free", shrink = T, nrow = 1) + theme_bw() + theme(axis.text.y=element_blank(), axis.title.y=element_text(size=16), axis.text.x=element_text(size=14), axis.title.x=element_text(size=16), legend.text = element_text(size=13), legend.title = element_text(size=14), strip.text = element_text(size=14))




```

---
```{r}
traj=read.table("~/Documents/Research/PloidySim/data/Ploidy_Forward_Sim_results.txt",head=T, sep=",")
traj2=read.table("~/Documents/Research/PloidySim/data/Ploidy_Forward_Sim_results_N1mil.txt",head=T, sep=",")

dipTraj=function(start_freq,s,h,stop_freq){
  h=1-h
  p=start_freq
  traj = c(p)
  fits = c(1.0-s, 1.0 - h*s, 1.0)
  while(p < stop_freq){
    g_freqs = c((1-p)^2, 2*p*(1 - p), p^2)
    tot_fit = sum(fits * g_freqs)
    p_fit = (g_freqs[3] * fits[3]) + 0.5*(g_freqs[2] * fits[2])
    p_prime = p_fit/tot_fit
    traj = c(traj,p_prime)
    p = p_prime
  }
  return(traj)
}

tetTraj=function(start_freq,s,h1,h2,h3,stop_freq){
  h1 = 1-h1
  h2 = 1-h2
  h3 = 1-h3
  p=start_freq
  traj = c(p)
  fits = c(1.0-s, 1.0 - h1*s, 1.0 - h2*s, 1.0 - h3*s, 1.0)
  while(p < stop_freq){
    g_freqs = c((1-p)^4, 4*p*(1 - p)^3, 6*p^2*(1 - p)^2, 4*p^3*(1 - p), p^4)
    tot_fit = sum(fits * g_freqs)
    p_fit = (g_freqs[5] * fits[5]) + 0.75*(g_freqs[4] * fits[4]) + 0.5*(g_freqs[3] * fits[3]) + 0.25*(g_freqs[2] * fits[2])
    p_prime = p_fit/tot_fit
    traj = c(traj,p_prime)
    p = p_prime
  }
  return(traj)
}

bbR=data.frame(traj=dipTraj(0.05,0.1,0,0.99))
bbR$gen=seq.int(nrow(bbR))
aaR=data.frame(traj=tetTraj(0.05,0.1,0,0,0,0.99))
aaR$gen=seq.int(nrow(aaR))

#recessive
ggplot(traj[traj$dom == "recessive" & traj$s==0.1,])+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==4,],aes(y=freq,x=gen,group=as.factor(rep)),color="blue",alpha=0.5)+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==2,],aes(y=freq,x=gen,group=as.factor(rep)),color="red",alpha=0.5)+geom_line(data=bbR,aes(y=traj,x=gen))+geom_line(data=aaR,aes(y=traj,x=gen))+facet_grid(~N,scales="free_x")+xlab("Generation")+ylab("Frequency")+theme(legend.title = element_text("Ploidy"))+scale_x_log10()

traj %>% filter(N %in% c(1000,10000) & s == 0.01 & dom == "recessive") %>% ggplot()+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==4 & traj$N %in% c(1000,10000),],aes(y=freq,x=gen,group=as.factor(rep)),color="blue",alpha=0.5)+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==2 & traj$N %in% c(1000,10000),],aes(y=freq,x=gen,group=as.factor(rep)),color="red",alpha=0.5)+geom_line(data=bbR,aes(y=traj,x=gen), linetype="dashed")+geom_line(data=aaR,aes(y=traj,x=gen))+facet_grid(~N,scales="free_x")+xlab("Generation")+ylab("Frequency")+theme(legend.title = element_text("Ploidy"))+scale_x_log10()

#dominant
bbD=data.frame(traj=dipTraj(0.05,0.1,1,0.95))
bbD$gen=seq.int(nrow(bbD))
aaD=data.frame(traj=tetTraj(0.05,0.1,1,1,1,0.95))
aaD$gen=seq.int(nrow(aaD))

ggplot(traj[traj$dom == "dominant" & traj$s==0.1,])+geom_line(data=traj[traj$dom == "dominant" & traj$s==0.1 & traj$ploidy==4,],aes(y=freq,x=gen,group=as.factor(rep)),color="blue",alpha=0.5)+geom_line(data=traj[traj$dom == "dominant" & traj$s==0.1 & traj$ploidy==2,],aes(y=freq,x=gen,group=as.factor(rep)),color="red",alpha=0.5)+geom_line(data=bbD,aes(y=traj,x=gen))+geom_line(data=aaD,aes(y=traj,x=gen))+facet_grid(~N,scales="free_x")+xlab("Generation")+ylab("Frequency")+theme(legend.title = element_text("Ploidy"))+scale_x_log10()

#additive
ggplot(traj[traj$dom == "recessive" & traj$s==0.1,])+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==4,],aes(y=freq,x=gen,group=as.factor(rep)),color="blue",alpha=0.5)+geom_line(data=traj[traj$dom == "recessive" & traj$s==0.1 & traj$ploidy==2,],aes(y=freq,x=gen,group=as.factor(rep)),color="red",alpha=0.5)+geom_line(data=bbR,aes(y=traj,x=gen))+geom_line(data=aaR,aes(y=traj,x=gen))+facet_grid(~N,scales="free_x")+xlab("Generation")+ylab("Frequency")+theme(legend.title = element_text("Ploidy"))+scale_x_log10()

params = data.frame("s" = rep(0.1,6), "dom" = c(rep(1,6)), "ploidy" = rep(c(2,4),3), "start" = rep(0.05, 6))
params %<>% dplyr::slice(rep(row_number(), 100))
# Create trajectories
dat1 = foreach(i = 1:nrow(params), .combine=rbind) %do% {
  print(i)
  getTraj(params[i,]$s, params[i,]$dom, params[i,]$ploidy, params[i,]$start, maxGens = 999999, N = 1000000)
}



```


# Background {.tabset}

## Dominance 

This plot shows the dominance value of each genotype (given by within individual allele frequency) as a function of the dominance scalar.  The purpose was to write a function that would take a single dominance value that could be specified for any ploidy and return a comparable set of dominance coefficients for heterozygous genotypes.

```{r, echo=T,message=F}
getDomCoefs = function(dominance, ploidy = 100){
  if (dominance == 0){
    coeffs = rep(0, ploidy - 1)
  }
  else if (dominance == 1){
    coeffs = rep(1, ploidy - 1)
  }
  else {
    dom = (1 - dominance) - 0.5
    dom = abs((dom * 10 + sign(dom)) ^ sign(dom))
    coeffs = (seq(1, ploidy - 1) / ploidy) ^ dom
  }
  return(coeffs)
}

doms = c(seq(0,1, 0.1))
Doms = as.data.frame(sapply(doms, getDomCoefs))
Doms = rbind(c(0,0,0,0,0,0,0), Doms, c(1,1,1,1,1,1,1))
colnames(Doms) = doms
Doms = cbind(Doms, data.frame("i/k"=seq(0,100) / 100))
mDoms = melt(Doms, id.var = "i.k")
ggplot(mDoms, aes(x = i.k, y = value, color = variable)) + geom_line() + scale_color_discrete(name = "Dominance\nScalar") + theme_bw() + xlab("i / k") + ylab("Dominance Coefficient")

mDoms %>% filter(variable %in% c("0.1", "0.5", "0.9")) %>% ggplot(., aes(x = i.k, y = value, linetype = variable)) + geom_line() + scale_color_discrete(name = "Dominance", breaks = c("0.1", "0.5", "0.9"), labels = c("Partial\nRecessivity\n", "Additive\n", "Partial\nDominance")) + theme_bw() + xlab("Individual allele frequency of beneficial allele") + ylab("Dominance Coefficient")

mDoms$variable = factor(mDoms$variable, levels(mDoms$variable)[c(rev(seq(1,11)))])

#Color
mDoms %>% filter(variable %in% c("0.1", "0.5", "0.9")) %>% ggplot(., aes(x = i.k, y = value, color = variable)) + geom_line(size = 1.2) + scale_color_manual(name = "Dominance", breaks = c("0.9", "0.5", "0.1"), labels = c("Partial\nDominance", "Additive", "Partial\nRecessivity\n"), values = c("#E6A0C4", "#C6CDF7", "#D8A499")) + theme_bw() + xlab("Individual allele frequency of beneficial allele") + ylab("Dominance Coefficient") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

#Linetype
mDoms %>% filter(variable %in% c("0.1", "0.5", "0.9")) %>% ggplot(., aes(x = i.k, y = value, linetype = variable)) + geom_line() + scale_linetype_manual(name = "Dominance", breaks = c("0.1", "0.5", "0.9"), labels = c("Partial\nRecessivity\n", "Additive\n", "Partial\nDominance"), values = c("dashed", "solid","dotdash")) + theme_bw() + xlab("Individual allele frequency of beneficial allele") + ylab("Dominance Coefficient") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

mDoms %>% filter(variable %in% c("0.9", "0.6", "0.5", "0.4", "0.1")) %>% ggplot(., aes(x = i.k, y = value, color = variable)) + geom_line(size = 1.2) + scale_color_discrete(name = "Dominance\nScalar", breaks = c("0.9", "0.6", "0.5", "0.4", "0.1"), labels = c("0.4", "0.1", "0", "-0.1", "-0.4")) + theme_bw() + xlab("Individual allele frequency of beneficial allele") + ylab("Dominance Coefficient") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))
# Example

# dominance=c(seq(0.1,0.9,0.1))
# > dominance
# [1] 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9

# Centers around 0.5 (additivity)
# dom = (1 - dominance) - 0.5
# > dom
# [1]  0.4  0.3  0.2  0.1  0.0 -0.1 -0.2 -0.3 -0.4

# dom1 = abs((dom * 10 + sign(dom)) ^ sign(dom))
# > dom1
# [1] 5.0000000 4.0000000 3.0000000 2.0000000 1.0000000 0.5000000 0.3333333 0.2500000 0.2000000

# > getDomCoefs(dominance = 0.2, ploidy = 4)
# [1] 0.00390625 0.06250000 0.31640625
# > getDomCoefs(dominance = 0.5, ploidy = 4)
# [1] 0.25 0.50 0.75

```

## Sweep trajectories

These plots show a primary motivating result for this study, in that higher ploidies show increased fixation times of sweeping beneficial alleles regardless of the dominance scenario being evaluated.

```{r, echo=T,message=F}
#Function creates trajectories
getTraj = function(s, dom, ploidy, start_freq, N = -9, end_freq = 0.99, maxGens = 9999, maxTries = 10){
  dom_coeffs = getDomCoefs(dom, ploidy)
  attempts = 0
  p = start_freq
  k = ploidy
  gen = 0
  while (attempts <= maxTries & p < end_freq & gen <= maxGens){
    df = data.frame("s" = s, "dom" = dom, "gen" = 0, "freq" = start_freq, "dp1" = 0, "w.bar" = 0, "ploidy" = ploidy)
    p = start_freq
    dp1 = 0
    gen = 0
    het_fits = 1 + dom_coeffs * s
    fits = c(1, het_fits, 1 + s) / (1 + s)
    while (p < end_freq & p > 0 & gen <= maxGens){
      q = 1 - p
      i = seq(0, k)
      Num = sum(choose(k, i) * ((k - i) / k) * (p ^ (k - i)) * (q ^ i) * rev(fits))
      Den = sum(choose(k, i) * (p ^ (k - i)) * (q ^ i) * rev(fits))
      p_prime = Num / Den
      if (N != -9){
        p_prime = sum(rbinom(N, k, p_prime)) / (k * N) 
      }
      df = rbind(df, c(s, dom, gen, p, dp1, Den, k))
      dp1 = p_prime - p
      p = p_prime
      gen = gen + 1
    }
    df = rbind(df, c(s, dom, gen, p, dp1, Den, k))
    attempts = attempts + 1
  }
  if (attempts > maxTries & nrow(df) <= maxGens){
    print(paste("Beneficial allele was lost due to drift for", maxTries, "consecutive attempts"))
  }
  if (nrow(df) > maxGens){
    print(paste("Beneficial allele did not fix before the maximum number of generations (", maxGens, ")."))
  }
  return(df[-1,])
}

# Param set to create trajectories for
params = data.frame("s" = rep(0.1,9), "dom" = c(rep(1,3), rep(0.5,3), rep(0,3)), "ploidy" = rep(c(2,4,8),3), "start" = rep(0.05, 9))

# Create trajectories
dat1 = foreach(i = 1:nrow(params), .combine=rbind) %do% {
  getTraj(params[i,]$s, params[i,]$dom, params[i,]$ploidy, params[i,]$start, maxGens = 999999)
}

dat1$dom = as.factor(dat1$dom)
dat1$dom = factor(dat1$dom, levels(dat1$dom)[c(3,2,1)])

#plot
ggplot(dat1, aes(x=gen, y=freq, linetype=as.factor(dom), color=as.factor(ploidy))) + geom_line() + scale_color_discrete(name="Ploidy") + scale_linetype_discrete(name="Dominance Scalar", labels=c("0.1", "0.5", "0.9")) + xlim(0,300) + theme_bw() + xlab("Generation") + ylab("Allele Frequency")

#ALL
dat1 %>% filter(ploidy %in% c(2, 4, 8) & dom %in% c(0.1, 0.5, 0.9)) %>% 
ggplot(., aes(x=gen, y=freq, linetype=as.factor(dom), color=as.factor(ploidy))) + geom_line() + scale_color_manual(name = "Ploidy", values = c("#F8766D", "#00BA38", "#619CFF")) + scale_linetype_manual(name = "Dominance", labels=c("Partial\nRecessivity\n", "Additivity", "Partial\nDominance")) + xlim(0,300) + theme_bw() + xlab("Generation") + ylab("Allele Frequency") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

#All together
dat1 %>% filter(ploidy %in% c(2, 4, 8) & dom %in% c(0, 0.5, 1)) %>% ggplot(., aes(x=gen, y=freq, linetype=as.factor(dom), color=as.factor(ploidy))) + geom_line(size = 1.2) + scale_color_manual(name = "Ploidy", values = c("#F8766D", "#00BA38", "#619CFF")) + scale_linetype_manual(name = "Dominance", labels=c("Dominant", "Additive", "Recessive"), values = c("dashed", "solid", "dotted")) + xlim(0,500) + theme_bw() + xlab("Generation") + ylab("Allele Frequency") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

#Additive and non-additive apart
dat1 %>% filter(ploidy %in% c(2, 4, 8) & dom %in% c(0.5)) %>% ggplot(., aes(x=gen, y=freq, color=as.factor(ploidy))) + geom_line(size = 1.2) + scale_color_manual(name = "Ploidy", values = c("#F8766D", "#00BA38", "#619CFF")) + xlim(0,500) + theme_bw() + xlab("Generation") + ylab("Allele Frequency") + theme(axis.text.y=element_text(size=14), axis.title.y=element_text(size=16),axis.text.x=element_text(size=14),axis.title.x=element_text(size=16),legend.text = element_text(size=14), legend.title = element_text(size=16))

dat1 %>% filter(ploidy %in% c(2, 4, 8) & dom %in% c(0, 1) & mod(gen,100)==0) %>% ggplot(., aes(x=gen, y=freq, linetype=as.factor(dom), color=as.factor(ploidy))) + geom_line(size = 1.2) + scale_color_manual(name = "Ploidy", values = c("#F8766D", "#00BA38", "#619CFF")) + scale_linetype_manual(name = "Dominance", labels=c("Dominant", "Recessive"), values = c("dashed", "dotted")) + scale_x_log10() + theme_bw() + xlab("Generation") + ylab("Allele Frequency") + theme(axis.text.y=element_text(size=14), axis.title.y=element_text(size=16),axis.text.x=element_text(size=14),axis.title.x=element_text(size=16),legend.text = element_text(size=14), legend.title = element_text(size=16))

dat1 = read.csv("~/Documents/Research/PloidySim/data/fixationTimes_byN.csv")
dat1 %>%  mutate(Dom = factor(case_when(dom == 0.1 ~ "Partial\nRecessivity (H = -0.4)", dom == 0.5 ~ "Additivity (H = 0)", dom == 0.9 ~ "Partial\nDominance (H = 0.4)"), levels = c("Partial\nRecessivity (H = -0.4)", "Additivity (H = 0)", "Partial\nDominance (H = 0.4)"))) %>% ggplot(aes(y = log(gen), fill = as.factor(N), x = as.factor(ploidy))) + geom_boxplot(outlier.size = 0.5) + facet_wrap(~Dom) + ylab("Log(Time to Fixation)") + xlab("Ploidy") + scale_fill_discrete(name = "N")+ theme_bw() + theme(axis.text.y=element_text(size=14), axis.title.y=element_text(size=16),axis.text.x=element_text(size=14),axis.title.x=element_text(size=16),legend.text = element_text(size=14), legend.title = element_text(size=16), strip.text = element_text(size=12))


#Stochastic effect of population size on
params = data.frame("s" = rep(0.1,12), "dom" = c(rep(0.1,4), rep(0.5,4), rep(0.9,4)), "ploidy" = rep(c(2,4), 6), "start" = rep(0.05, 12), "N" = rep(c(1000, 1000, 10000, 10000), 3))
params %<>% dplyr::slice(rep(row_number(), 1000))
# Create trajectories
dat1 = foreach(i = 1:nrow(params), .combine=rbind) %do% {
  print(params[i,])
  dat = getTraj(params[i,]$s, params[i,]$dom, params[i,]$ploidy, params[i,]$start, N = params[i,]$N, maxGens = 9999999, maxTries = 9999999)
  dat["N"] = params[i,]$N
  dat[nrow(dat),]
}

dat1 %>%  mutate(Dom = factor(case_when(dom == 0.1 ~ "Partial Recessivity", dom == 0.5 ~ "Additivity", dom == 0.9 ~ "Partial Dominance"), levels = c("Partial Recessivity", "Additivity", "Partial Dominance"))) %>% ggplot(aes(y = log(gen), fill = as.factor(N), x = as.factor(ploidy))) + geom_boxplot() + facet_wrap(~Dom) + ylab("Log(Time to Fixation)") + xlab("Ploidy") + scale_fill_discrete(name = "Population Size")+ theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))
```

## Fitness

First plot shows reason why allele frequency change is faster in lower ploidies; increased variance in fitness at any given frequency.  The second plot just shows mean fitness as a function of allele frequency and is not terribly interesting.
```{r, echo=T,message=F}
getFits = function(s, dom, ploidy){
  dom_coeffs = getDomCoefs(dom, ploidy)
  k = ploidy
  dat = foreach(i = 1:51, .combine=rbind) %do% {
    p = seq(0,1,1/50)[i]
    q = 1 - p
    het_fits = 1 + dom_coeffs * s
    fits = c(1, het_fits, 1 + s) / (1 + s)
    i = seq(0, k)
    freqs = choose(k, i) * (p ^ (k - i)) * (q ^ i)
    w.bar = sum(freqs * rev(fits))
    var.w = sum((freqs * (rev(fits) - w.bar) ^ 2) / length(freqs))
    data.frame('s' = s, 'dom' = dom, 'ploidy' = ploidy, 'freq' = p, 'w.bar' = w.bar, 'var.w' = var.w)
  }
  return(dat)
}

dat2 = foreach(i = 1:nrow(params), .combine=rbind) %do% {
  getFits(params[i,]$s, params[i,]$dom, params[i,]$ploidy)
}

dat2$dom = as.factor(dat2$dom)
dat2$dom = factor(dat2$dom, levels(dat2$dom)[c(3,2,1)])

#Figure 1 right
ggplot(dat2, aes(x=freq, y=var.w, color = as.factor(ploidy), linetype=as.factor(dom))) + geom_line(size = 0.9) + scale_color_discrete(name="Ploidy") + scale_linetype_manual(name="Dominance", labels=c("Dominant","Additive","Recessive"), values = c("dashed", "solid", "dotted")) + xlab("Allele Frequency") + ylab("Variance in Fitness\n") + theme_bw() + theme(axis.text.y=element_blank(), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

ggplot(dat2, aes(x=freq, y=w.bar, color = as.factor(ploidy), linetype=as.factor(dom))) + geom_line() + scale_color_discrete(name="Ploidy") + scale_linetype_discrete(name="Dominance", labels=c("0.1","0.5","0.9")) + xlab("Allele Frequency") + ylab("Mean Fitness") + theme_bw()
```

---

# mssel analysis

### Variable key
* N = Population size

* s = selection coefficient; difference in fitness between alternative homozygotes

* dom = dominance scalar; a single value that determines the dominance coefficients of heterozygous genotypes for an arbitrary ploidy

* recomb = per-base recombination rate

* mu = per-base mutation rate.  Theta is ploidy x mu x N (x sequence length which is 1Mb)

* sim_ploidy = **Simulation Ploidy**; ploidy used for mssel simulation.  Value used in calculating theta above

* traj_ploidy = **Trajectory Ploidy**; ploidy used to generate sweep trajectory.  see getTraj() function in PloidyHitch.R

* sampGen = sampling generation; number of generations passed since selection ends (i.e. fixation of beneficial allele)

* fuseGen = fuse generation; number of generations prior to start of sweep that the two populations fused.

**Simulation Ploidy** and **Trajectory Ploidy** are the two focal variables.  The former refers to the ploidy value used to scale population parameters when running mssel.  For example, theta = 2(N)(mu)(sim_ploidy).  The latter refers to the ploidy used for simulating the sweep trajectory, which is subsequently passed to mssel.


## Summary of depth and breadth of dips in diversity {.tabset}
Controlling for number of chromosomes in the population (i.e. Simulation Ploidy), higher ploidies have a shallower dip, due to the slowed rate of fixation of the sweeping allele. 
Similarly, the dips in diversity are narrower in higher ploidies for same reason as before. 

### Depth
```{r, echo=T,message=F}
MS2.a = ms %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% summarize(depth.pi = mean(Pi.2,na.rm=T) - min(Pi.1), min.pi = min(Pi.1, na.rm=T), max.taj = abs(min(Tajima.D_1, na.rm = T)), height.fst = max(fst, na.rm = T) - mean(fst, na.rm = T))

MS2.b = ms %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep, ints) %>% summarize(lessWind.pi = ifelse(mean(Pi.1, na.rm=T) < (mean(Pi.2, na.rm=T) / 2),1,0), lessWind.taj = ifelse(mean(Tajima.D_1, na.rm=T) < -1, 1, 0))

MS2.c = MS2.b %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep) %>% summarize(breadth.pi = sum(lessWind.pi) * 20000, breadth.taj = sum(lessWind.taj) * 20000)

MS2.f = merge(MS2.a, MS2.c, by = c("s", "dom", "recomb", "N", "mu", "sim_ploidy", "traj_ploidy", "sampGen", "fuseGen", "driftGen", "rep"))

MS2.f %<>% mutate(same_ploidy = ifelse(sim_ploidy==traj_ploidy, "yellow", "black"))

MS2.f %>% filter(sim_ploidy == traj_ploidy & mu==1e-08 & N == 10000 & s =="0.01" & driftGen %in% c(0,1) & sampGen == 1 & dom %in% c(0.1, 0.5, 0.9)) %>% mutate(Dom = factor(case_when(dom == 0.1 ~ "Partial Recessivity", dom == 0.5 ~ "Additivity", dom == 0.9 ~ "Partial Dominance"), levels = c("Partial Recessivity", "Additivity", "Partial Dominance")), Height = (log(min.pi, 10)), Breadth = breadth.pi/10000, Magnitude = depth.pi, Size = breadth.pi * depth.pi) %>% select(Dom, traj_ploidy, Magnitude, Breadth, Size) %>% melt(., id.var = c("Dom", "traj_ploidy")) %>% ggplot(., aes(y = value, fill = as.factor(Dom), x = as.factor(traj_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Dominance", values=wes_palette("Royal1")) + facet_wrap(~variable, scales = "free_y") + ylab("") + xlab("Ploidy") + theme_bw() + theme(axis.text.y=element_text(size = 16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

#disentangling
MS2.f %>% filter(mu==1e-08 & N == 10000 & s =="0.01" & driftGen %in% c(0,1) & sampGen == 1 & dom %in% c(0.5)) %>% mutate(Height = (log(min.pi, 10)), Breadth = breadth.pi/10000, Magnitude = depth.pi) %>% select(sim_ploidy, traj_ploidy, Magnitude, Breadth, same_ploidy) %>% melt(., id.var = c("sim_ploidy", "traj_ploidy", "same_ploidy")) %>% ggplot(., aes(y = value, fill = as.factor(traj_ploidy), x = as.factor(sim_ploidy), color = same_ploidy)) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Trajectory Ploidy", values = wes_palette("Moonrise2")) + scale_color_manual(guide=F, values = c("black", "red")) + facet_wrap(~variable, scales = "free_y") + ylab("") + xlab("\n\n") + theme_bw() + theme(axis.text.y=element_text(size = 16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18), legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

# New functions to summarize breadth/depth
# getDims = function(dat, y.metric = "fst", offset = 100000){
#   # dat = data.frame("mid" = mid, "fst" = febugst)
#   peak = tryCatch({
#     peaks(dat$mid, abs(dat[,y.metric])) %>% filter(x > 500000 - offset & x < 500000 + offset & w > 0) %>% filter(w == max(w)) %>% summarize(height = max(y), width = max(w))}
#     , error = function(e){
#       return(data.frame("height" = -9, "width" = -9))
#     })
#   return(peak$height * peak$width)
# }

getDims = function(dat, y.metric = "fst", offset = 100000){
  # dat = data.frame("mid" = mid, "fst" = febugst)
  peak = tryCatch({
    auc(dat$mid, unlist(abs(dat[,y.metric])), from = 500000 - offset, to = 500000 + offset)}
    , error = function(e){
      return(-9)
    })
  return(peak)
}

getUnd = function(dat, y.metric = "fst", offset = 100000){
  # dat = data.frame("mid" = mid, "fst" = febugst)
  dat = dat %>% filter(mid > 500000 - offset & mid < 500000 + offset)
  dat["stat"] = dat[, y.metric]
  val1 = nrow(dat[dat$stat == "-Inf",])
  val2 = nrow(dat[is.na(dat$stat),])
  return(val1+val2)
}

getUnd.h = function(dat, y.metric = "fst", offset = 100000){
  # dat = data.frame("mid" = mid, "fst" = febugst)
  dat = dat %>% filter(POSITION > 500000 - offset & POSITION < 500000 + offset)
  dat["stat"] = dat[, y.metric]
  val1 = nrow(dat[dat$stat == "-Inf",])
  val2 = nrow(dat[is.na(dat$stat),])
  return(val1+val2)
}

ms %>% filter(sampGen==1 & driftGen == 0 & fuseGen %in% c(1,1000,10000) & dom %in% c(0.1, 0.5, 0.9)) %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% mutate(Div = mean(Pi.2) - Pi.1, Tajima.D_1 = abs(Tajima.D_1)) %>% ungroup() %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen)) %>% mutate(und.taj = map(data, ~getUnd(., y.metric = "Tajima.D_1")), und.h = map(data, ~getUnd(., y.metric = "Fay.Wu.H_1")), und.e = map(data, ~getUnd(., y.metric = "Zeng.E_1")), und.ihs = map(data, ~getUnd(., y.metric = "iHS")), und.xp = map(data, ~getUnd(., y.metric = "XPEHH"))) %>% select(-data) %>% unnest() %>% group_by(s, dom, recomb, N, sim_ploidy) %>% summarize(n = n(), unds.d = sum(und.taj), unds.h = sum(und.h), unds.e = sum(und.e), unds.ihs = sum(und.ihs), unds.xp = sum(und.xp))


getStat = function(dat, stat, offset = 25000){
  dat = dat %>% filter(mid > 500000 - offset & mid < 500000 + offset)
  val = max(abs(unlist(dat[,stat])), na.rm = T)
  return(val)
  }

dd = ms %>% filter(sim_ploidy == traj_ploidy & fuseGen==1 & s == "0.01" & recomb == "1e-08" & N=="10000" & driftGen == 0 & sampGen %in% c(1,1000,10000)) %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% mutate(Fst = scale(fst)) %>% ungroup() %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen)) %>% mutate(size.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")), size.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")), size.e = map(data, ~getDims(., y.metric = "Zeng.E_1")), size.fst = map(data, ~getDims(., y.metric = "Fst")), size.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")), med.d = map(data, ~getStat(., "Tajima.D_1")), med.e = map(data, ~getStat(., "Zeng.E_1")), med.h = map(data, ~getStat(., "Fay.Wu.H_1")), med.fst = map(data, ~getStat(., "Fst")), med.dxy = map(data, ~getStat(., "dxy.1.2"))) %>% select(-data) %>% unnest() 

dd = ms %>% filter(sim_ploidy == traj_ploidy & fuseGen==1 & s == "0.01" & recomb == "1e-08" & N=="10000" & driftGen == 0 & sampGen %in% c(1,1000,10000)) %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen)) %>% mutate(size.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")), size.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")), size.e = map(data, ~getDims(., y.metric = "Zeng.E_1")), size.fst = map(data, ~getDims(., y.metric = "Fst")), size.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")), med.d = map(data, ~getStat(., "Tajima.D_1")), med.e = map(data, ~getStat(., "Zeng.E_1")), med.h = map(data, ~getStat(., "Fay.Wu.H_1")), med.fst = map(data, ~getStat(., "Fst")), med.dxy = map(data, ~getStat(., "dxy.1.2"))) %>% select(-data) %>% unnest() 

dd.points.dom.size = dd %>% filter(dom %in% c("0.1", "0.9") & traj_ploidy == sim_ploidy & s == "0.01" & recomb == "1e-08" & N=="10000" & driftGen == 0)  %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e) %>% select(sim_ploidy, dom, sampGen, TajD, FayWuH, ZengsE) %>% melt(., id.var = c("sim_ploidy", "sampGen", "dom")) %>% mutate("Area" = variable) %>% filter(value != 40.5) %>% group_by(sim_ploidy, sampGen, dom, variable) %>% summarize(median = median(value)) %>% mutate(Magnitude = variable)

dd.points.size = dd %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & recomb == "1e-08" & N=="10000" & driftGen == 0)  %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e) %>% select(sim_ploidy, dom, sampGen, TajD, FayWuH, ZengsE) %>% melt(., id.var = c("sim_ploidy", "sampGen", "dom")) %>% mutate("Area" = variable) %>% filter(value != 40.5) %>% group_by(sim_ploidy, sampGen, dom, variable) %>% summarize(median = median(value)) %>% mutate(Magnitude = variable)

#sampGen effect
# Peak Size
dd %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0)  %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e) %>% select(sim_ploidy, sampGen, TajD, FayWuH, ZengsE) %>% melt(., id.var = c("sim_ploidy", "sampGen")) %>% mutate("Magnitude" = variable) %>% filter(value != 40.5) %>% ggplot(., aes(y = value / 10000, fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + geom_point(data = dd.points, aes(x = as.factor(sim_ploidy), y = median / 10000, group = sampGen, shape = as.factor(dom)), position = position_dodge(width = 0.85)) + scale_fill_manual(name = "Generations\nsince Fixation", values = wes_palette("Royal2")) + ylab("Peak Area") + xlab("Ploidy") + facet_wrap(~Magnitude) + theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18), legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

#Just magnitude
dd %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & recomb == 1e-08 & sampGen != 1)  %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e) %>% select(sim_ploidy, sampGen, TajD, ZengsE) %>% melt(., id.var = c("sim_ploidy", "sampGen")) %>% mutate("Magnitude" = variable) %>% filter(value != 40.5) %>% ggplot(., aes(y = value, fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Generations\nsince Fixation", values = wes_palette("Royal2")) + ylim(0,2) + ylab("Magnitude") + xlab("Ploidy") + facet_wrap(~Magnitude) + theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18), legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

#Combined sample gen figures
kkk = merge(dd, ff, by = c("traj_ploidy", "sim_ploidy", "dom", "s", "N", "mu", "recomb", "sampGen", "fuseGen", "rep"), all = T)

kkk.1 = kkk %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & recomb == 1e-08)  %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e, "Fst" = med.fst, "Dxy" = med.dxy, "XPEHH" = med.xp, "iHS" = med.ihs) %>% select(sim_ploidy, sampGen, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% melt(., id.var = c("sim_ploidy", "sampGen")) %>% mutate(stat = "MaxValue")

kkk.med.points = kkk %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & recomb == 1e-08)  %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e, "Fst" = med.fst, "Dxy" = med.dxy, "XPEHH" = med.xp, "iHS" = med.ihs) %>% select(sim_ploidy, sampGen, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% melt(., id.var = c("sim_ploidy", "sampGen")) %>% mutate(stat = "MaxValue") %>% group_by(sim_ploidy, sampGen, variable) %>% summarize(value = median(value, na.rm=T))

kkk.2 = kkk %>% filter(dom == 0.5 & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & recomb == 1e-08)  %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, "iHS" = size.ihs) %>% select(sim_ploidy, sampGen, TajD, ZengsE, FayWuH, Fst, Dxy, XPEHH, iHS) %>% melt(., id.var = c("sim_ploidy", "sampGen")) %>% mutate(stat = "AUC")

kkk.3 = rbind(kkk.1, kkk.2)

scaleFUN <- function(x) sprintf("%.1f", x)

#Combined AUC and MaxValue
kkk.3 %>% filter(variable %in% c("sim_ploidy", "sampGen", "TajD", "Fst", "iHS", "XPEHH") & stat == "AUC") %>% mutate(variable = factor(variable, levels = c("TajD", "Fst", "iHS", "XPEHH"))) %>% ggplot(., aes(y = value / 100000, fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + geom_point(data = kkk.med.points[kkk.med.points$variable %in% c("TajD", "Fst", "iHS", "XPEHH"),], aes(y = value), shape = 4, position = position_dodge(width = 0.8)) + scale_fill_manual(name = "Generations\nsince Fixation", values = wes_palette("Royal2")) + scale_y_continuous(labels=scaleFUN) + ylab("Peak Size") + xlab("Ploidy") + facet_wrap(~variable, scales = "free", shrink = T, nrow = 1) + theme_bw() + theme(axis.text.y=element_text(size = 12), axis.title.y=element_text(size=16), axis.text.x=element_text(size=13), axis.title.x=element_text(size = 16), legend.text = element_text(size=13), legend.title = element_text(size=14), strip.text = element_text(size=14))

kkk.3 %>% filter(variable %in% c("sim_ploidy", "sampGen", "TajD", "Fst", "iHS", "XPEHH") & stat == "MaxValue") %>% ggplot(., aes(y = value, fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Generations\nsince Fixation", values = wes_palette("Royal2")) + scale_y_continuous(labels=scaleFUN) + ylab("Max Value") + xlab("Ploidy") + facet_wrap(~variable, scales = "free", shrink = T, nrow = 1) + theme_bw() + theme(axis.text.y=element_text(size = 12), axis.title.y=element_text(size=16), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18), legend.text = element_text(size=13), legend.title = element_text(size=14), strip.background = element_blank(), strip.text.x = element_blank())


dom.rehh = read.csv("~/Documents/Research/PloidySim/rehh/dom/rehh_dom.csv")
rehh = read.csv("~/Documents/Research/PloidySim/rehh/rehh_calcs_do0.5_fG1_nDS.csv")

ff = rehh %>% filter(!is.na(xpehh.p) & sampGen!=1000) %>% mutate(mid = POSITION) %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen)) %>% mutate(size.xp = map(data, ~getDims(., y.metric = "XPEHH")), size.xp.p = map(data, ~getDims(., y.metric = "xpehh.p")), med.xp = map(data, ~getStat(., "XPEHH")), med.xpp = map(data, ~log(getStat(., "xpehh.p"))), size.ihs = map(data, ~getDims(., y.metric = "iHS")), size.ihs.p = map(data, ~getDims(., y.metric = "ihs.p")), med.ihs = map(data, ~getStat(., "iHS")), med.ihs.p = map(data, ~log(getStat(., "ihs.p"))), rep = driftGen) %>% select(-c(data, driftGen)) %>% unnest()

ff %<>% mutate(traj_ploidy = as.numeric(str_replace(traj_ploidy, "tp","")), sim_ploidy = as.numeric(str_replace(sim_ploidy, "sp","")), dom = as.numeric(str_replace(dom, "do","")), s = as.numeric(str_replace(s, "se","")), N = as.numeric(str_replace(N, "NN","")), mu = as.numeric(str_replace(mu, "mu","")), recomb = as.numeric(str_replace(recomb, "re","")), sampGen = as.numeric(str_replace(sampGen, "sG","")), fuseGen = as.numeric(str_replace(fuseGen, "fG","")), rep = as.numeric(str_replace(rep, "rep", "")))

# ee = ms %>% filter(sampGen==1 & driftGen == 0 & fuseGen %in% c(1,1000,10000) & dom %in% c(0.1, 0.5, 0.9)) %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen)) %>% mutate(height.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")$height), width.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")$width), height.fst = map(data, ~getDims(.)$height), med.fst = map(data, ~getStat(., "fst")), width.fst = map(data, ~getDims(.)$width), height.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")$height), width.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")$width), height.e = map(data, ~getDims(., y.metric = "Zeng.E_1")$height), width.e = map(data, ~getDims(., y.metric = "Zeng.E_1")$width), height.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")$height), width.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")$width), med.dxy = map(data, ~getStat(., "dxy.1.2")), height.div = map(data, ~getDims(., y.metric = "Pi.2")$height), width.div = map(data, ~getDims(., y.metric = "Pi.2")$width), med.div = map(data, ~getStat(., "Pi.2"))) %>% select(-data) %>% unnest()

ee = ms %>% filter(sampGen==1 & driftGen == 0 & fuseGen %in% c(1,1000,10000) & dom %in% c(0.1, 0.5, 0.9)) %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% mutate(Div = mean(Pi.2) - Pi.1, Tajima.D_1 = abs(Tajima.D_1)) %>% ungroup() %>% nest(-c(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen)) %>% mutate(size.div = map(data, ~getDims(., y.metric = "Div")), size.taj = map(data, ~getDims(., y.metric = "Tajima.D_1")), size.h = map(data, ~getDims(., y.metric = "Fay.Wu.H_1")), size.e = map(data, ~getDims(., y.metric = "Zeng.E_1")), size.fst = map(data, ~getDims(., y.metric = "fst")), size.dxy = map(data, ~getDims(., y.metric = "dxy.1.2")), med.d = map(data, ~getStat(., "Tajima.D_1")), med.e = map(data, ~getStat(., "Zeng.E_1")), med.h = map(data, ~getStat(., "Fay.Wu.H_1")), med.fst = map(data, ~getStat(., "fst")), med.dxy = map(data, ~getStat(., "dxy.1.2"))) %>% select(-data) %>% unnest()

kk = merge(ee, ff, by = c("traj_ploidy", "sim_ploidy", "dom", "s", "N", "mu", "recomb", "sampGen", "fuseGen", "rep"), all.x = T)

kk.points = kk %>% filter(dom %in% c("0.1", "0.5", "0.9") & traj_ploidy == sim_ploidy & s == "0.01" & recomb == "1e-08" & N=="1000" & driftGen == 0 & sampGen == 1)  %>% mutate("TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "XPEHH" = size.xp, "Diversity" = size.div * 10) %>% select(sim_ploidy, dom, TajD, FayWuH, ZengsE, Fst, XPEHH, Diversity) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% group_by(sim_ploidy, dom, variable) %>% summarize(median = median(value)) %>% mutate(PeakSize = variable)

#dominance figure
kk %>% filter(dom %in% c(0.1, 0.5, 0.9) & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & sampGen == 1 & recomb == 1e-08 & fuseGen == 1) %>% mutate("Diversity" = size.div, "TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, same_ploidy = ifelse(sim_ploidy == traj_ploidy, 1, 0)) %>% select(sim_ploidy, dom, Diversity, TajD, FayWuH, ZengsE, Fst, XPEHH) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% ggplot(., aes(y = value / 10000, fill = as.factor(dom), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + geom_point(data = kk.points, aes(y = median / 10000, x = as.factor(sim_ploidy)), position = position_dodge(width = 0.8), size = 2, shape = 4) + scale_fill_manual(name = "Dominance\nScalar", values = wes_palette("Royal1"), labels = c("-0.4 (Partial\nRecessive)", "\n0 (Additive)\n", "0.4 (Partial\nDominance)")) + ylab("Peak Area") + xlab("Ploidy") + facet_wrap(~PeakSize, scales = "free_y") +theme_bw() + theme(axis.text.y=element_blank(), axis.ticks.y = element_blank(), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=16), legend.text = element_text(size=14), legend.title = element_text(size=16), strip.text = element_text(size=16))

#magnitude instead
kk %>% filter(dom %in% c(0.1, 0.5, 0.9) & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & sampGen == 1 & recomb == 1e-08 & fuseGen == 1) %>% mutate("TajD" = med.d, "FayWuH" = med.h, "ZengsE" = med.e, "Fst" = med.fst, "Dxy" = med.dxy, "XPEHH" = med.xp, "Rsb" = med.rsb, same_ploidy = ifelse(sim_ploidy == traj_ploidy, 1, 0)) %>% select(sim_ploidy, dom, TajD, FayWuH, ZengsE, Fst, Dxy, XPEHH) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% ggplot(., aes(y = value, fill = as.factor(dom), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Dominance", values = wes_palette("Royal1")) + ylab("") + xlab("Ploidy") + facet_wrap(~PeakSize, scales = "free_y") +theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18), legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

#Just diversity for panel
kk %>% filter(dom %in% c(0.1, 0.5, 0.9) & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & sampGen == 1 & recomb == 1e-08 & fuseGen == 1) %>% mutate("Diversity" = size.div, "TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, same_ploidy = ifelse(sim_ploidy == traj_ploidy, 1, 0)) %>% select(sim_ploidy, dom, Diversity) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% ggplot(., aes(y = value, fill = as.factor(dom), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + geom_point(data = kk.points[kk.points$variable == "Diversity",], aes(y = median, x = as.factor(sim_ploidy)), position = position_dodge(width = 0.8), size = 2, shape = 4) + scale_fill_manual(name = "Dominance\nScalar", values = wes_palette("Royal1"), labels = c("-0.4 (Recessive)", "\n0 (Additive)\n", "0.4 (Dominant)")) + ylab("Peak Area") + xlab("Ploidy") + theme_bw() + theme(axis.text.y=element_text(size = 12), axis.title.y=element_text(size=14), axis.text.x=element_text(size=12), axis.title.x=element_text(size=14), legend.text = element_text(size=12), legend.title = element_text(size=14), strip.text = element_text(size=16))

#Without X's
kk %>% filter(dom %in% c(0.1, 0.5, 0.9) & traj_ploidy == sim_ploidy & s == "0.01" & N=="10000" & driftGen == 0 & sampGen == 1 & recomb == 1e-08 & fuseGen == 1) %>% mutate("Diversity" = size.div, "TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, same_ploidy = ifelse(sim_ploidy == traj_ploidy, 1, 0)) %>% select(sim_ploidy, dom, Diversity) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% ggplot(., aes(y = value, fill = as.factor(dom), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Dominance\nScalar", values = wes_palette("Royal1"), labels = c("-0.4 (Recessive)", "\n0 (Additive)\n", "0.4 (Dominant)")) + ylab("Peak Area") + xlab("Ploidy") + theme_bw() + theme(axis.text.y=element_text(size = 12), axis.title.y=element_text(size=14), axis.text.x=element_text(size=12), axis.title.x=element_text(size=14), legend.text = element_text(size=12), legend.title = element_text(size=14), strip.text = element_text(size=16))

kk %>% filter(dom %in% c(0.1, 0.5, 0.9) & traj_ploidy == sim_ploidy & s == "0.01" & N=="1000" & driftGen == 0 & sampGen == 1 & recomb == 1e-08 & fuseGen == 1) %>% mutate("Diversity" = size.div, "TajD" = size.taj, "FayWuH" = size.h, "ZengsE" = size.e, "Fst" = size.fst, "Dxy" = size.dxy, "XPEHH" = size.xp, same_ploidy = ifelse(sim_ploidy == traj_ploidy, 1, 0)) %>% select(sim_ploidy, dom, Diversity) %>% melt(., id.var = c("sim_ploidy", "dom")) %>% mutate("PeakSize" = variable) %>% filter(value != -9) %>% ggplot(., aes(y = value, fill = as.factor(dom), x = as.factor(sim_ploidy))) + geom_boxplot(outlier.shape = NA) + scale_fill_manual(name = "Dominance\nScalar", values = wes_palette("Royal1"), labels = c("-0.4 (Recessive)", "\n0 (Additive)\n", "0.4 (Dominant)")) + ylab("Peak Area") + xlab("Ploidy") + theme_bw() + theme(axis.text.y=element_text(size = 12), axis.title.y=element_text(size=14), axis.text.x=element_text(size=12), axis.title.x=element_text(size=14), legend.text = element_text(size=12), legend.title = element_text(size=14), strip.text = element_text(size=16))
```

### Breadth
```{r, echo=T,message=F}
MS2.b = ms %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep, ints) %>% summarize(lessWind = ifelse(mean(Pi.1, na.rm=T) < (mean(Pi.2, na.rm=T) / 2),1,0))

MS2.c = MS2.b %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep) %>% summarize(breadth = sum(lessWind) * 20000)

MS2.c %>% filter(fuseGen == 1 & mu==1e-08 & N == 10000 & recomb=="1e-08" & s =="0.01" & sampGen == 1) %>% ggplot(., aes(y=breadth/1000, fill = as.factor(traj_ploidy), x = as.factor(sim_ploidy))) + geom_boxplot(notch=T) + ylab(expression(paste("Dip Breadth = Length (kb) of which ", pi[1], " < (",pi[2], " / 2)",sep = ""))) + scale_fill_discrete(name = "Trajectory\nPloidy") + xlab("Simulation Ploidy") + theme_bw()


```

### Dominance
```{r}
MS2.a = ms %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% summarize(depth.pi = mean(Pi.2,na.rm=T) - min(Pi.1), min.pi = min(Pi.1, na.rm=T), max.taj = abs(min(Tajima.D_1, na.rm = T)), height.fst = max(fst, na.rm = T) - mean(fst, na.rm = T))

MS2.b = ms %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep, ints) %>% summarize(lessWind.pi = ifelse(mean(Pi.1, na.rm=T) < (mean(Pi.2, na.rm=T) / 2),1,0), lessWind.taj = ifelse(mean(Tajima.D_1, na.rm=T) < -1, 1, 0))

MS2.c = MS2.b %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep) %>% summarize(breadth.pi = sum(lessWind.pi) * 20000, breadth.taj = sum(lessWind.taj) * 20000)

MS2.f = merge(MS2.a, MS2.c, by = c("s", "dom", "recomb", "N", "mu", "sim_ploidy", "traj_ploidy", "sampGen", "fuseGen", "driftGen", "rep"))

MS2.f %<>% mutate(same_ploidy = ifelse(sim_ploidy==traj_ploidy, "yellow", "black"))

n1k = MS2.f %>% filter(sim_ploidy == traj_ploidy & s == 0.01 & mu==1e-08 & N == 1000 & driftGen %in% c(0,1) & sampGen == 1 & dom %in% c(0.1, 0.5, 0.9)) %>% mutate(Height = (log(min.pi, 10)), Breadth = breadth.pi, Magnitude = depth.pi, Area = breadth.pi * depth.pi / 2) %>% group_by(sim_ploidy, dom) %>% summarize(Breadth = median(Breadth), Magnitude = median(Magnitude), Area = median(Area))
m.n1k = melt(n1k, id.var = c("sim_ploidy", "dom"))

#Current dominance fig.  Includes median for N = 1000
MS2.f %>% filter(sim_ploidy == traj_ploidy & mu==1e-08 & s == 0.01 & driftGen %in% c(0,1) & N == 10000 & sampGen == 1 & dom %in% c(0.1, 0.5, 0.9)) %>% mutate(Height = (log(min.pi, 10)), Breadth = breadth.pi/10000, Magnitude = depth.pi, Area = breadth.pi * depth.pi / 2) %>% select(recomb, dom, traj_ploidy, Area) %>% melt(., id.var = c("recomb", "dom", "traj_ploidy")) %>% ggplot(., aes(y = value, fill = as.factor(dom), x = as.factor(traj_ploidy))) + geom_boxplot(outlier.shape = NA) + geom_point(data = m.n1k[m.n1k$dom %in% c(0.1, 0.5, 0.9) & m.n1k$variable %in% c("Area"),], aes(y = value * 10, x = as.factor(sim_ploidy)), position = position_dodge(width = 0.8), size = 4, shape = 4) + scale_fill_manual(name = "Dominance\nScalar", values = wes_palette("Royal1")) + ylim(0,100) + ylab("Peak Area") + xlab("Ploidy") + theme_bw() + theme(axis.text.y=element_text(size = 16), axis.title.y=element_text(size=18), axis.text.x=element_text(size=16), axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18), strip.text = element_text(size=16))

```

### Decay
Does breadth of peak decay more quickly for a given simulation ploidy

```{r, echo=T,message=F}
MS2.c %>% filter(fuseGen == 1 & mu==1e-08 & N == 10000 & recomb=="1e-08" & s =="0.01") %>% ggplot(., aes(y=breadth/1000, fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(notch=T) + ylab(expression(paste("Dip Breadth = Length (1 kb) of which ", pi[1], " < (",pi[2], " / 2)",sep = ""))) + scale_y_log10() + scale_fill_discrete(name = "Generations prior\nto fixation") + xlab("Simulation Ploidy") + theme_bw()
```

### Drift
What happens if we let the beneficial allele drift neutrally for some number of generations prior to the start of selection

The allele is introduced at frequency 1/(C * N), where C is ploidy.  It then drifts for a specified number of generations as if it is in a population of size (C * N).  After this generation, selection starts.  So, a trajectory ploidy of 2 means that drift and selection are occuring as if this was a diploid population.  

Since drift happens more quickly in lower ploidies, the alleles that are not lost after X generations tend to be at higher frequency in lower ploidies.  As selection takes off, these higher starting frequencies result in higher diversity following the sweep.  Although the faster selection in lower ploidies promotes stronger signals of sweeps, the higher starting frequencies due to drift effectively erases or reverses the effect of ploidy on selection.
```{r}
sf = read.table("~/Documents/Research/PloidySim/data/drift_start_freqs.txt", header = T)

sf %>% mutate("Drift Generations" = ends, "Pop. Size" = N) %>% ggplot(., aes(fill = as.factor(ploidy), x = start_freq, y = ..scaled..)) + geom_density(alpha=0.5) + facet_grid(rows=vars(`Drift Generations`), cols = vars(`Pop. Size`), labeller = label_both, scales = "free_y") + ylab("") + xlab("Frequency") + ggtitle("Allele frequency distribution of new mutations \nsurviving after drifting for X generations") + scale_fill_discrete(name = "Ploidy") + theme_bw()

MS3.d = ms3 %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen) %>% summarize(depth = (mean(Pi.2,na.rm=T) - (mean(Pi.2,na.rm=T) - min(Pi.1))) / mean(Pi.2,na.rm=T))

MS3.d %>% filter(sampGen == 1 & fuseGen == 1 & mu==1e-08 & N == 10000 & recomb=="5e-08" & dom == 0.5) %>% ggplot(., aes(y=-(log(depth)), fill = as.factor(traj_ploidy), x = as.factor(sim_ploidy))) + geom_boxplot() + ylab(expression(paste("Dip Depth = [", bar(pi[2])," - (", bar(pi[2]), " - min(", pi[1], ")] / ", bar(pi[2]),sep = ""))) + facet_grid(cols = vars(driftGen), rows = vars(s), labeller = label_both) + scale_y_log10() + scale_fill_discrete(name = "Trajectory\nPloidy") + xlab("Simulation Ploidy") + theme_bw()

MS3.b = ms3 %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, rep, driftGen, ints) %>% summarize(lessWind = ifelse(mean(Pi.1, na.rm=T) < (mean(Pi.2, na.rm=T) / 2),1,0))

MS3.c = MS3.b %>% group_by(s, dom, recomb, N, mu, sim_ploidy, traj_ploidy, sampGen, fuseGen, driftGen, rep) %>% summarize(breadth = sum(lessWind) * 20000)

MS3.c %>% filter(sampGen == 1 & fuseGen == 1 & mu==1e-08 & N == 10000 & recomb=="1e-08" & dom == 0.5 & sampGen == 1) %>% ggplot(., aes(y=breadth/1000, fill = as.factor(traj_ploidy), x = as.factor(sim_ploidy))) + geom_boxplot() + facet_grid(cols = vars(driftGen), rows = vars(s), labeller = label_both, scales = "free_y") + ylab(expression(paste("Dip Breadth = Length (kb) of which ", pi[1], " < (",pi[2], " / 2)",sep = ""))) + scale_fill_discrete(name = "Trajectory\nPloidy") + xlab("Simulation Ploidy") + theme_bw()
```


# Diversity plots {.tabset}

## Trajectory effect
Here, we are keeping fixed the ploidy specified for the coalescent simulations (fixed at 8 in this example), and we are varying the ploidy under which the sweep trajectories are simulated.  For some parameter sets, higher ploidies and thus slower sweeps results in a visible difference in terms of the reduction of diversity at and around the beneficial allele.  The effect is more pronounced for weaker selection and for partial dominance/recessivity.  The breadth of the dips is also notably lesser for higher ploidies.  Thus, if chromosome number in a population is held constant, higher ploidies exhibit reduced signals associated with selective sweeps.

```{r, echo=T,message=F}
#Single panel figure
ms %>% filter(traj_ploidy==sim_ploidy & sampGen == "1" & s == 0.01 & dom == "0.5" & N == 10000) %>% ggplot(., aes(y=Pi.1 * 100, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9), limits = c(0.2,9.8)) + xlab("Position (100 kb)") + ylab("Diversity (%)") + scale_color_discrete(name="Ploidy") + theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

#Faceted with s and recomb
ms2 %>% filter(dom %in% c("0.1","0.9","0.5") & N == 10000 & fuseGen == 1 & sampGen ==1 & mu==1e-08 & sim_ploidy == 4) %>% ggplot(., aes(y=Pi.1 * 100, color = as.factor(traj_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") + ylab("Diversity (%)") + scale_color_discrete(name="Trajectory\nPloidy") + facet_grid(vars(s, recomb), vars(dom),labeller = label_both, scales = "free_y") + theme_bw()
```


## Factor-of-2 effect
This is the complement to the previous figure.  We use the same sweep trajectory, but we vary the ploidy specified for the coalescent simulation.  
```{r, echo=T,message=F}

ms2 %>% filter(dom %in% c("0.1","0.9","0.5") & fuseGen == 1 & sampGen ==1 & mu==1e-08 & N == 10000 & traj_ploidy == 4) %>% ggplot(., aes(y=Pi.1 * 100, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + scale_y_continuous(breaks=c(0.05,0.15)) + xlab("Position (100 kb)") + ylab("Diversity (%)") + scale_color_discrete(name="Simulation\nPloidy") + facet_grid(vars(recomb,s), vars(dom),labeller = label_both) + theme_bw()



```

## Combined effects
Higher ploidies result in deeper and broader dips in diversity relative to diploids.  The effect of recombination rate is not striking.
```{r, echo=T,message=F}
ms2 %>% filter(dom %in% c("0.1","0.9","0.5") & fuseGen == 1 & sampGen ==1 & mu==1e-08 & N == 10000 & sim_ploidy == traj_ploidy) %>% ggplot(., aes(y=Pi.1 * 100, color = as.factor(traj_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + scale_y_continuous(breaks=c(0.05,0.15)) + xlab("Position (100 kb)") + ylab("Diversity (%)") + scale_color_discrete(name="Ploidy") + facet_grid(vars(recomb,s), vars(dom),labeller = label_both) + theme_bw()
```

# Effect of trajectory ploidy, simulation ploidy, and sample generation on classic selection metrics {.tabset}



## Tajima's D

Polyploids recover new mutations more quickly, but they take longer to drift to higher frequencies.  ThetaW goes up but ThetaPi lags...
```{r, echoe=F}
# ms2 %>% filter(dom %in% c("0.1","0.9","0.5") & s==0.01 & fuseGen == 1 & mu==1e-08 & N == 10000 & sim_ploidy == traj_ploidy & recomb == 1e-08) %>% ggplot(., aes(y=Tajima.D_1, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") + ylab("Tajima's D") + scale_color_discrete(name="Ploidy") + facet_grid(vars(sampGen), vars(dom),labeller = label_both) + theme_bw()

ms2 %>% filter(dom == "0.5" & s==0.01 & fuseGen == 1 & mu==1e-08 & N == 10000 & recomb == 5e-08) %>% ggplot(., aes(y=Tajima.D_1, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") + ylab("Tajima's D") + scale_color_discrete(name="Ploidy") + facet_grid(vars(sampGen), vars(traj_ploidy),labeller = label_both) + theme_bw()
```

## Fst 

Neutral divergence in allele frequencies increases Fst more quickly in lower ploidies, thus erasing 'outlier' signal due to sweep
```{r, echo=T,message=F}
ms %>% filter(dom %in% c("0.1","0.9","0.5") & s==0.01 & fuseGen == 1 & mu==1e-08 & N == 10000 & sim_ploidy == traj_ploidy & recomb == 5e-08 & driftGen == 0) %>% ggplot(., aes(y=fst, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") + ylab("Fst") + scale_color_discrete(name="Ploidy") + facet_grid(vars(sampGen), vars(dom),labeller = label_both) + theme_bw()
```

---
# Evolution figures
```{r}
#Dominance curves
mDoms %>% filter(variable %in% c("0.1", "0.5", "0.9")) %>% ggplot(., aes(x = i.k, y = value, linetype = variable)) + geom_line() + scale_linetype_manual(name = "Dominance", breaks = c("0.1", "0.5", "0.9"), labels = c("Partial\nRecessivity\n", "Additive\n", "Partial\nDominance"), values = c("dashed", "solid","dotdash")) + theme_bw() + xlab("Individual allele frequency of beneficial allele") + ylab("Dominance Coefficient") + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18))

#Basic chromosome diversity plot
ms %>% filter(traj_ploidy==sim_ploidy & sampGen == "1" & s == 0.01 & dom == "0.5") %>% ggplot(., aes(y=Pi.1 * 100, color = as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5, span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") + ylab("Diversity (%)") + scale_color_discrete(name="Ploidy") + theme_bw() + theme(axis.text.y=element_text(size=16), axis.title.y=element_text(size=18),axis.text.x=element_text(size=16),axis.title.x=element_text(size=18),legend.text = element_text(size=16), legend.title = element_text(size=18)) + ylim(0, 0.2)
```

 # Analysis of rehh calculations    This R package calculates EHH
(Extended Haplotype Homozygosity) and related metrics, which can be used to
detect a selective sweep.  I'm showing results for the XP-EHH, the
cross-populatin EHH.   [Link to
Article](https://www.nature.com/articles/nature06250)   ### Import Data
```{r} 
traj.ehh = read.csv("~/Documents/Research/PloidySim/rehh/rehh_calcs_sp2_se0.01.csv") 
fact.ehh = read.csv("~/Documents/Research/PloidySim/rehh/rehh_calcs_do0.5_fG1_DS_fmted.csv") 
```
 
## Trajectory effect   Faster sweeps in the lower ploidies results in stronger signals of selection.   
```{r, echo=T,message=F}   
traj.ehh %>% filter(fuseGen=="fG1" & sampGen=="sG1" &
recomb == "re1e-08" & dom=="do0.5" & N=="NN10000") %>% ggplot(.,aes(x=POSITION /
100000,y=xpehh.p,color=traj_ploidy)) + geom_smooth(method="loess", span=0.1, se
= F) + scale_color_discrete(name="Trajectory\nPloidy",
breaks=c("tp2","tp4","tp8"), labels=c("2","4","8")) + xlab("Position (100 kb)")
+ ylab(expression("-log"[10]*"(p-value)")) + theme_bw()
```

# Factor-of-two effect   Trajectory ploidy is constant within each panel, while simulation ploidy is varied.  Higher diversity in higher ploidies produces stronger signal due to greater deviation from baseline genomic diversity. Something strange here though...why is p value always highest when tp=sp? Maybe look at density of NA along chromosomes?

```{r, echo=T,message=F}   
fact.ehh %>% filter(s == "se0.01" & fuseGen=="fG1" &
recomb == "re1e-08" & dom=="do0.5" & N=="NN10000") %>% ggplot(.,aes(x=POSITION /
100000, y=xpehh.p, color=sim_ploidy)) + geom_smooth(method="loess", span=0.1, se
= F) + scale_color_discrete(name="Simulation\nPloidy", breaks=c("sp2","sp4","sp8"), labels=c("2","4","8"))  + facet_grid(cols = vars(traj_ploidy), rows = vars(sampGen))  + xlab("Position (100 kb)") + ylab(expression("-log"[10]*"(p-value)")) + theme_bw()   
```

## Sample generation effect   Does signal decay faster in higher or lower
ploidies?   Answer seems to be that decay is faster in lower ploidies.
Drift is faster in lower ploidies, which is primary mechanism that erases signal
of selection.     
```{r}   
fact.ehh %>% filter(s == "se0.01" &
fuseGen=="fG1" & dom=="do0.5" & N=="NN10000" & recomb=="re1e-08") %>%
ggplot(.,aes(x=POSITION,y=xpehh.p,color=sim_ploidy)) + geom_smooth() +
facet_grid(rows = vars(traj_ploidy), cols = vars(sampGen))   
```  

---   # Less interesting analyses   
### Effect of sample
generation   Sample generation is the number of generations following a
sweep at which sampling occurs   
```{r}    
ms2 %>% filter(dom %in%
c("0.1","0.9","0.5") & s==0.01 & fuseGen == 1 & mu==1e-08 & N == 10000 & recomb
== 5e-08 & sim_ploidy == traj_ploidy) %>% ggplot(., aes(y=Pi.1 * 100, color =
as.factor(sim_ploidy), x = mid/100000)) + geom_smooth(method="loess", size =0.5,
span=0.1, se=F) + scale_x_continuous(breaks=c(1,5,9)) +
scale_y_continuous(breaks=c(0.05,0.15)) + xlab("Position (100 kb)") +
ylab("Diversity (%)") + scale_color_discrete(name="Simulation\nPloidy") +
facet_grid(vars(sampGen), vars(dom),labeller = label_both) + theme_bw()  
```

### Effect of population size   Nothing really interesting
here...Smaller population size seems noisier as expected   
```{r}
 ms2 %>% filter(dom %in% c("0.1","0.9","0.5") & recomb=="1e-08" & fuseGen ==
1 & sampGen ==1 & mu==1e-08 & sim_ploidy == traj_ploidy) %>% ggplot(.,
aes(y=Pi.1 * 100, color = as.factor(traj_ploidy), x = mid/100000)) +
geom_smooth(method="loess", size =0.5, span=0.1, se=F) +
scale_x_continuous(breaks=c(1,5,9)) + xlab("Position (100 kb)") +
ylab("Diversity (%)") + scale_color_discrete(name="Ploidy") + facet_grid(vars(s,
N), vars(dom),labeller = label_both, scales = "free_y") + theme_bw()  
``` 
  ### Other plots   
```{r}   fact.ehh %>%
filter(traj_ploidy == "tp4" & fuseGen=="fG1" & dom=="do0.5" & N=="NN10000" &
recomb=="re1e-08" & sampGen=="sG1") %>% ggplot(.,aes(x=cut_interval(x=POSITION,
n=50),y=xpehh.p,fill=sim_ploidy)) + geom_boxplot() + facet_grid(cols =
vars(sampGen))   # # Look for proportional difference in breadth/depth
within a simul   MS2.a %>% filter(fuseGen == 1 & mu==1e-08 & traj_ploidy
== 4 & N == 10000 & recomb=="1e-08" & s =="0.01") %>% ggplot(., aes(y=depth,
fill = as.factor(sampGen), x = as.factor(sim_ploidy))) + geom_boxplot(notch=T) +
ylab(expression(paste("Dip Breadth = Length of which ", pi[1], " < (",pi[2], " /
2)",sep = "")))+ scale_fill_discrete(name = "Trajectory\nPloidy") +
xlab("Simulation Ploidy") + theme_bw()   fact.ehh %>%
filter(sim_ploidy=="sp8" & fuseGen=="fG1" & sampGen=="sG1" & recomb == "re1e-08"
& dom=="do0.5" & N=="NN10000") %>% ggplot(.,aes(x=POSITION /
100000,y=xpehh.p,color=traj_ploidy)) + geom_smooth(method="loess", span=0.1, se
= F) + scale_color_discrete(name="Trajectory\nPloidy",
breaks=c("tp2","tp4","tp8"), labels=c("2","4","8")) + xlab("Position (100 kb)")
+ ylab(expression("-log"[10]*"(p-value)")) + theme_bw()   ```  
```{r}   diffusionDensity = function(start_freq, N, ploidy, t){  
x = seq(0, 1, 0.01)     d = N * ploidy     p = start_freq  
dens = (6 * p * (1 - p) * exp(-t/d)) + (30 * p * (1 - p) * (1 - 2*p) * (1 - 2 *
x ) * exp((-3*t)/d))     return(data.frame("dens" = dens, x = x)) 
 }   aa = diffusionDensity(1/4000, 1000, 4, 1000)   aa %<>%
mutate(ul = x, ll = lag(x), height = (lag(dens) + dens) / 2, width = ul - ll,
area = height * width) %>% filter(area > 0) %>% select(-x) %>% mutate(prob =
area / sum(area))   dfreq = sample(aa$ul, 1, replace = T, prob = aa$prob)
  Drift = function(N, ploidy, end, tries){     drift = function(N,
ploidy, end, tries){       C = N * ploidy # # of chromosomes   p =
0 # Current frequency       traj = c(1/C)       while(p == 0){ 
       p = rbinom(1, C, (1 / C)) / (C) # Draw # of mutant alleles for next
generation and divive by C to get freq       }       t = 1 
     traj = c(traj, p)       while(p != 0 & p != 1 & t < end){ # Loop
till absorption or beginning of selection         p = rbinom(1, C, p) / C
        t = t + 1         traj = c(traj, p)       } 
     return(traj)     }     tt = 1     traj = drift(N,
ploidy, end)     while(tt < tries & (traj[length(traj)] == 0 |
traj[length(traj)] == 1)){       traj = drift(N, ploidy, end)  
}     return(traj)   }   ``` 

